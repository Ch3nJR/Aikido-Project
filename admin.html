<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aikiForest</title>
    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/general.css" />
    <link rel="stylesheet" href="css/admin.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"
    />
    <script src="https://unpkg.com/scrollreveal"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  </head>

  <body>
    <!--Scroll to top btn-->
    <!-- <div class="scrollToTop-btn flex-center">
      <i class="bi bi-arrow-up"></i>
    </div> -->

    <section class="sec-02">
      <div class="container">
        <h3 class="section-title">Add Promotions Here</h3>
        <div class="listingcontent">
          <div class="box-container">
            <label><b>Promotions Name:</b></label>
            <input id="nameinp" type="text" placeholder="Name" />
          </div>

          <div class="box-container">
            <label><b>Promotions Price:</b></label>
            <input id="priceinp" type="text" placeholder="Price" />
          </div>

          <div class="box-container">
            <label><b>Promotion Link:</b></label>
            <input
              id="promolinkinp"
              type="text"
              placeholder="Eg. www.test.com"
            />
          </div>

          <div class="box-container">
            <label><b>Link Caption:</b></label>
            <input id="linkcapinp" type="text" placeholder="Eg. Sign Up" />
          </div>

          <div class="box-container">
            <label id="pdlab"><b>Promotions Description :</b></label>
            <textarea id="desarea"></textarea><br /><br />
          </div>
          <div id="imagesDiv"></div>
        </div>

        <input
          class="imgInp"
          type="file"
          id="testImg"
          name="img"
          accept="image/png, image/jpeg, image/jpg, image/gif"
        />

        <button class="upload-btn btn">Upload</button>

        <img class="testImg" src="" alt="" />
      </div>
    </section>

    <!--=======product display=======-->
    <div id="productsDiv" class="container"></div>

    <!-- Firebase services are still in test mode, and need to be transitioned to locked mode in the future, for realtimeDB and storage -->
    <script type="module">
      // Import the functions you need from the SDKs you need (https://firebase.google.com/docs/web/learn-more#available-libraries)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

      import {
        getStorage,
        ref as strRef,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

      import {
        getDatabase,
        ref as DatabaseRef,
        set,
        child,
        get,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBpX4VZrjnFPrAi7Rwdjpz2p7_ZlGzIFk4",
        authDomain: "aikido-test-90953.firebaseapp.com",
        projectId: "aikido-test-90953",
        storageBucket: "aikido-test-90953.appspot.com",
        // The value of `databaseURL` depends on the location of the database
        databaseURL:
          "https://aikido-test-90953-default-rtdb.asia-southeast1.firebasedatabase.app/",
        messagingSenderId: "763006449505",
        appId: "1:763006449505:web:cd3895906b924be58a3720",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      // Initialize Cloud Storage and get a reference to the service
      const storage = getStorage(app);

      $(".upload-btn").click(function () {
        let img = $(".imgInp").prop("files")[0];
        let imgRef = strRef(storage, "images/" + img.name);

        uploadBytes(imgRef, img).then((snapshot) => {
          // Upload completed successfully, now we can get the download URL
          getDownloadURL(snapshot.ref).then((downloadURL) => {
            $(".testImg").attr("src", downloadURL);
            setPromoData(
              $("#nameinp").val(),
              $("#priceinp").val(),
              $("#desarea").val(),
              snapshot.ref._location.path_,
              $("#promolinkinp").val(),
              $("#linkcapinp").val()
            );
          });
        });
      });

      // Initialize Realtime Database and get a reference to the service
      const database = getDatabase(app);
      function setPromoData(
        promotionName,
        promotionPrice,
        promotionDescription,
        promotionImageRef,
        promotionLink,
        promotionLinkText
      ) {
        console.log(promotionImageRef);
        set(DatabaseRef(database, "promotions/" + promotionName), {
          promo_name: promotionName,
          promo_price: promotionPrice,
          promo_desc: promotionDescription,
          promo_img_ref: promotionImageRef,
          promo_link: promotionLink ? promotionLink : null,
          promo_link_txt: promotionLinkText,
        });
      }
    </script>

    <!-- <script>
      /*Variables & References*/
      var Files = [];
      var FileReaders = [];
      var ImageLinksArray = [];

      const imgdiv = document.getElementById("imagesDiv");
      const selBtn = document.getElementById("selimgsbtn");
      const addBtn = document.getElementById("addprodbtn");
      const proglab = document.getElementById("loadlab");
      const uploadstat = document.getElementById("uploadstat");

      const name = document.getElementById("nameinp");
      const price = document.getElementById("priceinp");
      const description = document.getElementById("desarea");

      function OpenFileDialog() {
        let inp = document.createElement("input");
        inp.type = "file";
        inp.multiple = "multiple";

        inp.onchange = (e) => {
          AssignImgsToFilesArray(e.target.files);
          CreateImgTags();
        };

        inp.click();
      }

      function AssignImgsToFilesArray(thefiles) {
        let num = Files.length + thefiles.length;
        let looplim = num <= 1 ? thefiles.length : 1 - Files.length;

        for (let i = 0; i < looplim; i++) {
          Files.push(thefiles[i]);
        }

        if (num > 1) alert("Only 1 image is allowed!");
      }

      function CreateImgTags() {
        imgdiv.innerHTML = "";
        imgdiv.classList.add("imagesDivStyle");

        for (let i = 0; i < Files.length; i++) {
          FileReaders[i] = new FileReader();

          FileReaders[i].onload = function () {
            var img = document.createElement("img");
            img.id = "imgNo" + i;
            img.classList.add("imgs");
            img.src = FileReaders[i].result;
            imgdiv.append(img);
          };
          FileReaders[i].readAsDataURL(Files[i]);
        }
        let upstat = document.getElementById("uploadstat");
        upstat.innerHTML = "";
        upstat.style =
          "cursor:pointer;display:block;color:#111222; font-size:18px";
        imgdiv.append(upstat);
      }

      function ClearImages() {
        Files = [];
        ImageLinksArray = [];
        imgdiv.innerHTML = "";
        imgdiv.classList.remove("imagesDivStyle");
      }

      function getShortTitle() {
        let namey = name.value.substring(0, 50);
        return namey.replace(/[^a-zA-Z0-9]/g, "");
      }

      function GetImgUploadProgress() {
        return (
          "Images Uploaded " + ImageLinksArray.length + " of " + Files.length
        );
      }

      function IsAllImagesUploaded() {
        return ImageLinksArray.length == Files.length;
      }

      function RestoreBack() {
        selBtn.disabled = false;
        addBtn.disabled = false;
        proglab.disabled = false;
        location.reload();
      }

      //-----------------------------------EVENTS--------------------------------//
      // selBtn.addEventListener("click", OpenFileDialog);
      // addBtn.addEventListener("click", UploadAllImages);
      // proglab.addEventListener("click", ClearImages);

      //-----------------------------------UPLOAD TO FIREBASE--------------------------------//

      function UploadAllImages() {
        selBtn.disabled = true;
        addBtn.disabled = true;

        ImageLinksArray = [];

        for (let i = 0; i < Files.length; i++) {
          UploadAnImage(Files[i], i);
        }
      }

      function UploadAnImage(imgToUpload, imgNo) {
        const metadata = {
          contentType: imgToUpload.type,
        };

        const storage = getStorage();

        const ImageAddress =
          "TheImages/" + getShortTitle() + "/img#" + (imgNo + 1);

        const storageRef = sRef(storage, ImageAddress);

        const UploadTask = uploadBytesResumable(
          storageRef,
          imgToUpload,
          metadata
        );

        UploadTask.on(
          "state_changed",
          (snapshot) => {
            uploadstat.innerHTML = GetImgUploadProgress();
          },

          (error) => {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "Image failed to upload. Please try again.",
            });
          },

          () => {
            getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) => {
              ImageLinksArray.push(downloadURL);
              if (IsAllImagesUploaded()) {
                uploadstat.innerHTML = "All images successfully uploaded.";
                UploadAProduct();
              }
            });
          }
        );
      }

      //----------------------UPLOAD A PRODUCT---------------------

      function UploadAProduct() {
        set(ref(realdb, "TheProductRealdb/" + getShortTitle()), {
          ProductTitle: name.value,
          Price: price.value,
          Description: description.value,
          LinksOfImagesArray: ImageLinksArray,
        });
        RestoreBack();
      }

      var OuterDiv = document.getElementById("productsDiv");
      var ArrayOfProducts = [];
      window.addEventListener("load", GetAllProducts);

      function GetAllProducts() {
        const dbref = ref(realdb);

        get(child(dbref, "TheProductRealdb"))
          .then((snapshot) => {
            ArrayOfProducts = Object.values(snapshot.val());
          })
          .then(() => {
            AddAllProducts();
          });
      }

      function AddAllProducts() {
        ArrayOfProducts.forEach((prod, i) => {
          if (prod.LinksOfImagesArray) {
            AddAProduct(prod, i);
          }
        });
      }

      function AddAProduct(product, index) {
        let html =
          `
          <img src="` +
          product.LinksOfImagesArray[0] +
          `" class="thumb mt-2" id="thumb` +
          index +
          `">
          <p class="title flex-center" id="title` +
          index +
          `">` +
          product.ProductTitle +
          `</p>
          ` +
          `
          <h5 class="description">` +
          product.Description +
          `</h5>

          <p> SGD ` +
          product.Price +
          `</p>

          <button class="bn59" id="${
            "delbtn" + product.ProductTitle
          }" style="background-color: red">Delete</button>
          `;
        let newProd = document.createElement("div");
        newProd.classList.add("productcard");
        newProd.id = product.ProductTitle.toUpperCase();
        newProd.innerHTML = html;
        OuterDiv.append(newProd);

        const delbtn = document.getElementById("delbtn" + product.ProductTitle);

        delbtn.addEventListener("click", DelAProduct);
        delbtn.pdtTitle = product.ProductTitle;
      }

      function ProductDescription(array) {
        document.getElementById("description").innerHTML = product.Description;
        return ul.outerHTML;
      }

      function DelAProduct(evt) {
        let pdtTitle = evt.currentTarget.pdtTitle;
        set(
          ref(
            realdb,
            "TheProductRealdb/" + pdtTitle.replace(/[^a-zA-Z0-9]/g, "") + "/"
          ),
          {}
        ).then(() => {
          location.reload();
        });
      }
    </script> -->
  </body>
</html>
